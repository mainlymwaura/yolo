---
# Frontend Role Tasks for Stage 2

- name: "Prepare frontend deployment"
  block:
    - name: "Pull frontend Docker image"
      docker_image:
        name: "{{ frontend_image }}"
        source: pull
        state: present

  tags: ["frontend-setup"]

- name: "Deploy frontend container"
  block:
    - name: "Start frontend container"
      docker_container:
        name: "{{ frontend_container_name }}"
        image: "{{ frontend_image }}"
        state: started
        restart_policy: unless-stopped
        ports:
          - "{{ frontend_port_external }}:{{ frontend_port_internal }}"
        networks:
          - name: "{{ docker_network }}"
        env:
          REACT_APP_API_URL: "{{ react_app_api_url }}"

    - name: "Wait for frontend service to be ready"
      wait_for:
        host: localhost
        port: "{{ frontend_port_external }}"
        delay: 10
        timeout: 60

  tags: ["frontend-deploy"]

- name: "Verify application health"
  block:
    - name: "Check frontend accessibility"
      uri:
        url: "http://localhost:{{ frontend_port_external }}"
        method: GET
        status_code: [200, 301, 302]
      register: frontend_health
      retries: 3
      delay: 5
      until: frontend_health.status in [200, 301, 302]

  tags: ["frontend-health-check"]
